version: "3"
services:
  decidim:
    image: decidim/decidim:latest
    # Command runs database setup then starts the server
    # Skip seeding in production to avoid errors - seed manually if needed
    command: >
      sh -c "bundle exec rake db:prepare && 
             bundle exec rails s -b 0.0.0.0"
    ports:
      - "3000:3000"
    environment:
      # Required base configuration
      - RAILS_ENV=${RAILS_ENV:-production}
      - SECRET_KEY_BASE=${SERVICE_PASSWORD_SECRET_64}

      # Database configuration
      - DATABASE_HOST=pg
      - DATABASE_USERNAME=postgres
      - DATABASE_PASSWORD=${SERVICE_PASSWORD_DB}

      # Required SMTP configuration for emails
      - SMTP_ADDRESS=${SMTP_ADDRESS:?}
      - SMTP_DOMAIN=${SMTP_DOMAIN:?}
      - SMTP_USERNAME=${SMTP_USERNAME:?}
      - SMTP_PASSWORD=${SMTP_PASSWORD:?}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_STARTTLS_AUTO=${SMTP_STARTTLS_AUTO:-true}
      - SMTP_AUTHENTICATION=${SMTP_AUTHENTICATION:-plain}

      # Application configuration
      - DECIDIM_APPLICATION_NAME=${DECIDIM_APPLICATION_NAME:-My Decidim Instance}
      - DECIDIM_MAILER_SENDER=${DECIDIM_MAILER_SENDER:?}

      # Optional but recommended
      - DECIDIM_DEFAULT_LOCALE=${DECIDIM_DEFAULT_LOCALE:-en}
      - DECIDIM_AVAILABLE_LOCALES=${DECIDIM_AVAILABLE_LOCALES:-en,es,ca}

      # Redis configuration (if using Sidekiq for background jobs)
      - REDIS_URL=redis://redis:6379/0
  pg:
    image: postgres:latest
    volumes:
      # Updated for PostgreSQL 18+ compatibility
      # Uses /var/lib/postgresql instead of /var/lib/postgresql/data
      - pg-data:/var/lib/postgresql
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD:?}
      - POSTGRES_DB=${POSTGRES_DB:-decidim_production}
  redis:
    image: redis:latest
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
volumes:
  pg-data: {}
  redis-data: {}
