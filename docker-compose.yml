version: "3"
services:
  decidim:
    image: decidim/decidim:latest
    # Command runs database setup then starts the server
    command: >
      sh -c "bundle exec rake db:prepare && 
             bundle exec rake db:seed && 
             bundle exec rails s -b 0.0.0.0"
    ports:
      - "3000:3000"
    environment:
      - RAILS_ENV=${RAILS_ENV:-production}
      - DATABASE_HOST=pg
      - DATABASE_USERNAME=postgres
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:?}
      - SECRET_KEY_BASE=${SECRET_KEY_BASE:?}
  pg:
    image: postgres:latest
    volumes:
      # Updated for PostgreSQL 18+ compatibility
      # Uses /var/lib/postgresql instead of /var/lib/postgresql/data
      - pg-data:/var/lib/postgresql
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD:?}
      - POSTGRES_DB=${POSTGRES_DB:-decidim_production}
  redis:
    image: redis:latest
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
volumes:
  pg-data: {}
  redis-data: {}
